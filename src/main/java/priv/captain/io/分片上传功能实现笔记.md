---

# ğŸ“Œ åˆ†ç‰‡ä¸Šä¼ åŠŸèƒ½å¤ä¹ ç¬”è®°

---

## 1ï¸âƒ£ æ•°æ®åº“è®¾è®¡ï¼ˆä¸‰å¼ è¡¨ï¼‰

### 1.1 ç‰©ç†æ–‡ä»¶å­˜å‚¨è¡¨ `file_storage`

| å­—æ®µå           | ç±»å‹            | è¯´æ˜                   |
| ------------- | ------------- | -------------------- |
| id            | bigint / uuid | ä¸»é”®                   |
| file\_md5     | varchar       | æ–‡ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºå»é‡ï¼‰         |
| file\_name    | varchar       | æ–‡ä»¶å                  |
| file\_size    | bigint        | æ–‡ä»¶å¤§å°                 |
| file\_path    | varchar       | æ–‡ä»¶å­˜å‚¨è·¯å¾„               |
| status        | tinyint       | æ–‡ä»¶çŠ¶æ€ï¼ˆ0: ä¸Šä¼ ä¸­ï¼Œ1: ä¸Šä¼ å®Œæˆï¼‰ |
| gmt\_create   | datetime      | åˆ›å»ºæ—¶é—´                 |
| gmt\_modified | datetime      | æ›´æ–°æ—¶é—´                 |

**è¯´æ˜ï¼š**

* ç”¨äºå­˜å‚¨å®é™…çš„ç‰©ç†æ–‡ä»¶ä¿¡æ¯
* æ–‡ä»¶å»é‡é€šè¿‡ `file_md5` å®ç°

---

### 1.2 ç”¨æˆ·æ–‡ä»¶å…³ç³»è¡¨ `user_file`

| å­—æ®µå                  | ç±»å‹            | è¯´æ˜                     |
| -------------------- | ------------- | ---------------------- |
| id                   | bigint / uuid | ä¸»é”®                     |
| user\_id             | bigint        | ç”¨æˆ· ID                  |
| file\_id             | bigint        | å¯¹åº” `file_storage` çš„ id |
| original\_file\_name | varchar       | ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹æ–‡ä»¶å             |
| gmt\_create          | datetime      | åˆ›å»ºæ—¶é—´                   |

**è¯´æ˜ï¼š**

* æ”¯æŒåŒä¸€æ–‡ä»¶è¢«å¤šä¸ªç”¨æˆ·ä¸Šä¼ ï¼Œé¿å…é‡å¤å­˜å‚¨
* ä¿å­˜ç”¨æˆ·ä¸æ–‡ä»¶çš„å…³ç³»

---

### 1.3 åˆ†ç‰‡è®°å½•è¡¨ `file_chunk`

| å­—æ®µå           | ç±»å‹            | è¯´æ˜                  |
| ------------- | ------------- | ------------------- |
| id            | bigint / uuid | ä¸»é”®                  |
| file\_md5     | varchar       | æ–‡ä»¶å”¯ä¸€æ ‡è¯†              |
| chunk\_index  | int           | åˆ†ç‰‡ç´¢å¼•                |
| chunk\_size   | bigint        | åˆ†ç‰‡å¤§å°                |
| status        | tinyint       | åˆ†ç‰‡çŠ¶æ€ï¼ˆ0: æœªä¸Šä¼ ï¼Œ1: å·²ä¸Šä¼ ï¼‰ |
| gmt\_create   | datetime      | åˆ›å»ºæ—¶é—´                |
| gmt\_modified | datetime      | æ›´æ–°æ—¶é—´                |

**è¯´æ˜ï¼š**

* è®°å½•æ¯ä¸ªåˆ†ç‰‡ä¸Šä¼ çŠ¶æ€
* æ”¯æŒæ–­ç‚¹ç»­ä¼ 

---

## 2ï¸âƒ£ æ–‡ä»¶å­˜å‚¨ç›®å½•ç»“æ„

**ä¸´æ—¶åˆ†ç‰‡ç›®å½•ï¼š**

```
/tmp/upload/{fileMd5}_{userId}/{chunkIndex}
```

* `{fileMd5}_{userId}` ç”¨ä½œåˆ†ç‰‡ç›®å½•ï¼Œé¿å…ä¸åŒç”¨æˆ·å†²çª
* åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œåˆå¹¶åˆ°æœ€ç»ˆç›®å½•ï¼š

```
/final/path/{fileMd5}
```

* **åˆå¹¶è§„åˆ™**ï¼šåŒä¸€ä¸ª `fileMd5` åªå…è®¸ä¸€ä¸ªåˆå¹¶æ“ä½œ

---

## 3ï¸âƒ£ åˆ†ç‰‡ä¸Šä¼ å‰åç«¯æµç¨‹

### 3.1 å‰ç«¯æµç¨‹

1. é€‰æ‹©æ–‡ä»¶ï¼Œè®¡ç®— MD5
2. åˆ†ç‰‡åˆ‡å‰²
3. ä¸Šä¼ å‰è°ƒç”¨ `/checkUploadedChunks?fileMd5=xxx&userId=xxx`
4. éå†åˆ†ç‰‡ä¸Šä¼ ï¼ˆè·³è¿‡å·²ä¸Šä¼ åˆ†ç‰‡ï¼‰
5. ä¸Šä¼ å®Œæˆåè°ƒç”¨ `/mergeChunks?fileMd5=xxx&userId=xxx`

```ts
const tempDir = `${fileMd5}_${userId}`;
for (let i = 0; i < totalChunks; i++) {
    if (uploadedChunks.includes(i)) continue;
    const chunk = file.slice(i * chunkSize, (i + 1) * chunkSize);
    await uploadChunk(chunk, i, totalChunks, fileMd5, userId);
}
await mergeChunks(fileMd5, userId);
```

---

### 3.2 åç«¯é€»è¾‘

#### ä¸Šä¼ åˆ†ç‰‡æ¥å£ `/uploadChunk`

```java
@PostMapping("/uploadChunk")
public Result uploadChunk(MultipartFile fileChunk, String fileMd5, int chunkIndex, Long userId) {
    String tempDir = "/tmp/upload/" + fileMd5 + "_" + userId + "/";
    saveFile(fileChunk, tempDir + chunkIndex);
    markChunkUploaded(fileMd5, chunkIndex); // æ›´æ–° file_chunk è¡¨
    return success();
}
```

#### åˆå¹¶åˆ†ç‰‡æ¥å£ `/mergeChunks`ï¼ˆä½¿ç”¨ Redis åˆ†å¸ƒå¼é”ï¼‰

```java
@PostMapping("/mergeChunks")
public Result mergeChunks(String fileMd5) {
    String lockKey = "merge_lock:" + fileMd5;
    if (!redisLock.tryLock(lockKey, 30)) {
        return fail("æ–‡ä»¶æ­£åœ¨åˆå¹¶ä¸­");
    }
    try {
        List<File> chunks = getAllChunks(fileMd5); // åªæ ¹æ® fileMd5ï¼Œä¸åŒºåˆ† userId
        try (FileOutputStream out = new FileOutputStream("/final/path/" + fileMd5)) {
            for (File chunk : chunks) {
                Files.copy(chunk.toPath(), out);
            }
        }
        deleteTempChunks(fileMd5); // åˆ é™¤ä¸´æ—¶ç›®å½•
        markFileCompleted(fileMd5); // æ›´æ–° file_storage è¡¨
    } finally {
        redisLock.unlock(lockKey);
    }
    return success();
}
```

#### æŸ¥è¯¢å·²ä¸Šä¼ åˆ†ç‰‡ `/checkUploadedChunks`

```java
@GetMapping("/checkUploadedChunks")
public List<Integer> checkUploadedChunks(String fileMd5, Long userId) {
    return getUploadedChunksFromDb(fileMd5, userId);
}
```

---

## 4ï¸âƒ£ æ³¨æ„äº‹é¡¹ï¼ˆè¡¥å……ï¼‰

1. **Redis åˆ†å¸ƒå¼é”**

   * ä¿è¯åŒä¸€ä¸ª `fileMd5` åªä¼šæœ‰ä¸€ä¸ªåˆå¹¶æ“ä½œ
   * é¿å…å¹¶å‘åˆå¹¶å¯¼è‡´æ–‡ä»¶æŸå

2. **ç”¨æˆ·éš”ç¦»**

   * ä¸´æ—¶ç›®å½•ä½¿ç”¨ `{fileMd5}_{userId}`ï¼Œä¿è¯ä¸åŒç”¨æˆ·ä¸Šä¼ åŒä¸€æ–‡ä»¶ä¸ä¼šå†²çª

3. **åˆ†ç‰‡çŠ¶æ€**

   * `file_chunk.status = 1` è¡¨ç¤ºä¸Šä¼ æˆåŠŸ
   * åˆå¹¶å‰æ£€æŸ¥æ‰€æœ‰åˆ†ç‰‡çŠ¶æ€

4. **æ–‡ä»¶å»é‡**

   * åˆå¹¶å®Œæˆååªå­˜å‚¨ä¸€ä¸ªç‰©ç†æ–‡ä»¶
   * å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ `file_md5` å¯¹åº”çš„æ–‡ä»¶

5. **å¼‚å¸¸å¤„ç†**

   * ä¸Šä¼ å¤±è´¥å¯é‡è¯•
   * åˆå¹¶å¤±è´¥å¯é‡æ–°åŠ é”æ‰§è¡Œ
   * å®šæœŸæ¸…ç†è¶…æ—¶ä¸´æ—¶ç›®å½•

---