---

### 📘 文件上传复习笔记：分片上传

### ✅ 一、概念简介

**什么是分片上传？**

分片上传（Multipart Upload）是一种将大文件分割成多个**小块（chunk）**，然后分别上传这些小块到服务器，最后再由服务器将这些小块**合并**成完整文件的上传方式。

可以把分片上传想象成**快递拆分**：
- 你有一件非常重的家具要寄送（大文件）。
- 你不是直接搬运这件家具（传统上传），而是把它拆分成几个小包裹（文件分片）。
- 你分别将这些小包裹寄出去。
- 收件人收到所有小包裹后，再按照编号将它们组装成完整的家具。

**为什么用？**

🎯 **核心目的：** 解决大文件上传的痛点，提高上传的可靠性和效率。

* **断点续传（Resumeable Upload）**：这是分片上传最重要的优势。如果上传过程中网络中断，只需要重新上传未完成的分片，而不是整个文件。
* **提高上传效率**：可以并行上传多个分片，充分利用多线程和网络带宽，显著缩短大文件的上传时间。
* **降低单次失败率**：单次上传失败的概率与文件大小成正比。分片上传将大文件分解成小块，单次上传失败的可能性更小。
* **支持秒传（Instant Upload）**：如果服务器已经存在某个分片（通过哈希值判断），那么该分片无需再次上传。这为后续的“秒传”功能打下了基础。

---

### 🔹 二、核心流程与技术细节

分片上传通常包含以下几个核心步骤：

#### 1. 前端（客户端）

1.  **分片（Chunking）**：使用 JavaScript 的 `File` 对象 API，特别是 `File.slice()` 方法，将大文件分割成指定大小（如 5MB）的多个分片。
2.  **生成标识**：为整个文件生成一个唯一的哈希值（如 SHA-256），作为该文件在服务器上的唯一标识，用于后续的合并和秒传。
3.  **上传分片**：遍历所有分片，使用 `fetch` 或 `axios` 等异步请求库，将每个分片作为单独的请求发送到服务器。每个请求中应包含：
    * 文件标识（哈希值）。
    * 分片编号（chunk index）。
    * 分片数据。
4.  **管理状态**：客户端需要记录每个分片的上传状态（已上传、失败、待上传），以便实现断点续传。

#### 2. 后端（服务器）

1.  **预处理（Initialization）**：
    * 客户端向服务器发送一个初始化请求，告知文件总大小和分片信息。
    * 服务器返回一个上传 ID（Upload ID），用于后续识别此次上传任务。
2.  **接收分片（Receiving Chunks）**：
    * 服务器接收每个分片上传请求。
    * 验证分片（例如，检查哈希值）。
    * 将分片数据保存到**临时目录**，并使用唯一的名称（如 `uploadId_chunkIndex`）进行命名。
3.  **合并分片（Merging Chunks）**：
    * 当客户端所有分片都上传完成后，向服务器发送一个**合并请求**。
    * 服务器接收到请求后，根据上传 ID 和分片总数，从临时目录中找到所有分片。
    * 按照分片编号，依次读取并合并分片，生成最终的完整文件。
    * 最后，删除临时分片。
4.  **垃圾清理**：如果一个上传任务长时间未完成，服务器需要有机制来清理过期的临时分片，避免占用过多存储空间。

---

### ✅ 三、两种上传模式

分片上传有两种常见的模式：

#### 1. 并行上传（Parallel Upload）

* **工作方式**：客户端同时发送多个分片上传请求，充分利用网络带宽。
* **优点**：上传速度最快，适用于网络条件良好的场景。
* **缺点**：如果并发数设置不当，可能占用过多带宽，导致其他网络应用卡顿。

#### 2. 串行上传（Sequential Upload）

* **工作方式**：一个分片上传成功后，再上传下一个分片。
* **优点**：实现简单，对服务器压力小，避免了并发请求带来的复杂性。
* **缺点**：上传速度较慢。

通常，实际应用会结合这两种模式，设置一个合理的并发数，既能提高效率，又能避免资源过度消耗。

---

### 🔍 四、面试高频问题 + 深度解析

**1. 为什么要使用分片上传？它解决了什么问题？**

* **标准答案**：分片上传主要解决大文件上传的**可靠性**和**效率**问题。它通过将文件分割成小块，实现了**断点续传**、**并行上传**，并为**秒传**功能提供了基础。

**2. 如何实现断点续传？**

* **标准答案**：断点续传依赖于分片上传。
    1.  **客户端**：在开始上传前，客户端会检查本地上传进度。它会记录哪些分片已经成功上传。
    2.  **服务器**：当客户端发起续传请求时，服务器会根据文件的唯一标识（哈希值）和上传 ID，告知客户端**已完成上传的分片列表**。
    3.  **客户端**：客户端拿到这个列表后，只需继续上传那些**未完成的分片**即可。

**3. 如何实现秒传？**

* **标准答案**：秒传依赖于分片上传和文件的**唯一标识（哈希值）**。
    1.  **客户端**：在上传文件前，客户端会计算整个文件的哈希值。
    2.  **服务器**：客户端将这个哈希值发送给服务器。
    3.  **服务器**：服务器收到哈希值后，首先检查其存储系统中是否已经存在相同哈希值的文件。
    4.  **快速响应**：如果文件已存在，服务器直接返回上传成功，并提供文件链接。如果不存在，则转为正常的分片上传流程。

**4. 如果上传一个分片失败了怎么办？**

* **标准答案**：这正是分片上传的优势所在。
    * 客户端应该捕获上传失败的错误。
    * 将该分片标记为失败，并可以选择**重试**。
    * 如果重试多次仍然失败，可以提示用户，但其他成功上传的分片不会受到影响。

---

### 🎁 总结与建议

* 分片上传是处理大文件上传的**标准解决方案**，在所有主流的云存储服务（如阿里云 OSS、七牛云等）中都有广泛应用。
* 在面试中，能清晰地解释其核心流程、优缺点以及如何实现断点续传和秒传，将是你的加分项。
* **注意**：前端和后端的分片逻辑是紧密配合的。前端负责分片和管理上传状态，后端负责接收、保存和合并分片。

**思考题**：在实际应用中，你如何处理分片上传的并发控制？如果用户关闭了浏览器，服务器上的临时文件该如何清理？