ğŸ“˜ Java é¢è¯•å¤ä¹ ç¬”è®°ï¼šReentrantReadWriteLock

âœ… ä¸€ã€æ¦‚å¿µç®€ä»‹

**æ˜¯ä»€ä¹ˆï¼Ÿ**

`ReentrantReadWriteLock` æ˜¯ Java å¹¶å‘åŒ… `java.util.concurrent.locks` ä¸­çš„ä¸€ä¸ªé”å®ç°ï¼Œå®ƒæä¾›äº†æ¯” `ReentrantLock` æ›´ç»†ç²’åº¦çš„é”æ§åˆ¶ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒç”±ä¸¤æŠŠé”ç»„æˆï¼šä¸€æŠŠ**è¯»é”**ï¼ˆ`ReadLock`ï¼‰å’Œä¸€æŠŠ**å†™é”**ï¼ˆ`WriteLock`ï¼‰ã€‚

**ä¸ºä»€ä¹ˆç”¨ï¼Ÿ**

ğŸ¯ **æ ¸å¿ƒç›®çš„ï¼š** åœ¨è¯»å¤šå†™å°‘çš„å¹¶å‘åœºæ™¯ä¸‹ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡å’Œæ€§èƒ½ã€‚

  * **è¯»è¯»å¹¶å‘ï¼š** å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰è¯»é”ï¼Œè¿›è¡Œå¹¶å‘è¯»å–ã€‚
  * **å†™å†™äº’æ–¥ï¼š** ä»»ä½•æ—¶å€™ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™é”ï¼Œè¿›è¡Œç‹¬å å¼å†™å…¥ã€‚
  * **è¯»å†™äº’æ–¥ï¼š** è¯»é”å’Œå†™é”æ˜¯äº’æ–¥çš„ï¼Œå½“æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æ—¶ï¼Œå†™é”æ— æ³•è·å–ï¼›å½“æœ‰çº¿ç¨‹æŒæœ‰å†™é”æ—¶ï¼Œè¯»é”æ— æ³•è·å–ã€‚

è¿™ç§æœºåˆ¶å®Œç¾åŒ¹é…äº†â€œè¯»å¤šå†™å°‘â€çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®é¡¹ï¼Œå¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯è¢«è¯»å–ï¼Œåªæœ‰æå°‘æ—¶å€™æ‰éœ€è¦æ›´æ–°ã€‚å¦‚æœä½¿ç”¨ `ReentrantLock`ï¼Œå³ä½¿æ˜¯è¯»å–æ“ä½œä¹Ÿéœ€è¦æ’é˜Ÿï¼Œæå¤§åœ°é™ä½äº†æ€§èƒ½ã€‚è€Œ `ReentrantReadWriteLock` å…è®¸æ‰€æœ‰è¯»çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œå¤§å¤§æé«˜äº†å¹¶å‘æ•ˆç‡ã€‚

-----

ğŸ”¹ äºŒã€åº•å±‚åŸç† + æºç åˆ†æ

`ReentrantReadWriteLock` çš„åº•å±‚å®ç°åŒæ ·åŸºäº **AQSï¼ˆAbstractQueuedSynchronizerï¼‰**ã€‚å®ƒå·§å¦™åœ°å°†è¯»é”å’Œå†™é”çš„çŠ¶æ€æ‰“åŒ…åœ¨ä¸€ä¸ª `int` ç±»å‹çš„ AQS çŠ¶æ€å˜é‡ `state` ä¸­ã€‚

**æ ¸å¿ƒå­—æ®µ**

  * `state`ï¼šä¸€ä¸ª `int` ç±»å‹çš„ AQS çŠ¶æ€å˜é‡ã€‚`ReentrantReadWriteLock` å°†å…¶åˆ†ä¸ºé«˜ 16 ä½å’Œä½ 16 ä½ã€‚
      * **é«˜ 16 ä½ï¼š** è¯»é”çš„è®¡æ•°ã€‚è¡¨ç¤ºå½“å‰æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æŒæœ‰è¯»é”ã€‚
      * **ä½ 16 ä½ï¼š** å†™é”çš„è®¡æ•°ã€‚è¡¨ç¤ºå†™é”è¢«è·å–çš„æ¬¡æ•°ã€‚
  * **`ReadLock` å’Œ `WriteLock`ï¼š** å®ƒä»¬æ˜¯ `ReentrantReadWriteLock` çš„ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«å®ç°äº† `Lock` æ¥å£ã€‚å®ƒä»¬å…±äº«åŒä¸€ä¸ª `state` å˜é‡ã€‚

**æºç åˆ†æ - `acquire()` æ–¹æ³•**

`ReentrantReadWriteLock` çš„æ ¸å¿ƒé€»è¾‘éƒ½åœ¨å…¶åŒæ­¥å™¨ `Sync` ä¸­ã€‚æˆ‘ä»¬æ¥åˆ†æè¯»é”å’Œå†™é”æ˜¯å¦‚ä½•æ“ä½œ `state` çš„ã€‚

**1. å†™é”çš„è·å–ï¼ˆ`WriteLock.lock()`ï¼‰**

```java
// ReentrantReadWriteLock.java (Sync å†…éƒ¨ç±»)
protected final boolean tryAcquire(int acquires) {
    // å°è¯•è·å–å†™é”ï¼Œå¿½ç•¥å¯é‡å…¥æ€§ã€ä¸­æ–­ç­‰
    Thread current = Thread.currentThread();
    int c = getState(); // è·å–å½“å‰çŠ¶æ€
    int w = exclusiveCount(c); // ä½16ä½ï¼Œå†™é”è®¡æ•°

    // å¦‚æœçŠ¶æ€ä¸ä¸º0ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰é”
    if (c != 0) {
        // å¦‚æœä¸æ˜¯å†™é”çš„é‡å…¥ï¼Œå¹¶ä¸”æœ‰è¯»é”æˆ–å†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–å¤±è´¥
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        // å¦‚æœæ˜¯é‡å…¥ï¼Œä¸”é‡å…¥æ¬¡æ•°è¶…é™ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (w + exclusiveCount(acquires) > MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
        // æˆåŠŸï¼Œæ›´æ–° state
        setState(c + acquires);
        return true;
    }
    // å¦‚æœçŠ¶æ€ä¸º0ï¼Œä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œæˆ–è€… CAS æˆåŠŸï¼Œåˆ™è·å–å†™é”
    if (writerShouldBlock() || !compareAndSetState(c, c + acquires))
        return false;
    // æˆåŠŸï¼Œè®¾ç½®å†™é”æŒæœ‰è€…ä¸ºå½“å‰çº¿ç¨‹
    setExclusiveOwnerThread(current);
    return true;
}
```

  * **å†™é”æ˜¯ç‹¬å çš„ï¼ˆExclusiveï¼‰**ï¼šå®ƒåªå…³å¿ƒä½ 16 ä½ã€‚`tryAcquire` æ–¹æ³•é¦–å…ˆæ£€æŸ¥ `state` æ˜¯å¦ä¸º 0ï¼ˆå³é«˜ 16 ä½å’Œä½ 16 ä½éƒ½ä¸º 0ï¼‰ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–å†™é”ï¼Œåˆ™è·å–å¤±è´¥ã€‚åªæœ‰å½“ `state` ä¸º 0 æ—¶ï¼Œæ‰å°è¯•é€šè¿‡ `CAS` ç‹¬å åœ°è·å–å†™é”ã€‚

**2. è¯»é”çš„è·å–ï¼ˆ`ReadLock.lock()`ï¼‰**

```java
// ReentrantReadWriteLock.java (Sync å†…éƒ¨ç±»)
protected final int tryAcquireShared(int unused) {
    // å°è¯•è·å–è¯»é”ï¼Œå¿½ç•¥é‡å…¥ç­‰
    for (;;) {
        int c = getState();
        // å¦‚æœå†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œè¯»é”è·å–å¤±è´¥
        if (exclusiveCount(c) != 0 &&
            getExclusiveOwnerThread() != Thread.currentThread())
            return -1; // å¤±è´¥
        
        int r = sharedCount(c); // é«˜16ä½ï¼Œè¯»é”è®¡æ•°
        // å¦‚æœè¯»é”è®¡æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (r == MAX_COUNT)
            throw new Error("Maximum lock count exceeded");

        // å°è¯• CAS å¢åŠ è¯»é”è®¡æ•°ï¼Œå¦‚æœæˆåŠŸåˆ™è·å–æˆåŠŸ
        if (compareAndSetState(c, c + SHARED_UNIT)) {
            // ... åç»­é€»è¾‘ï¼ŒåŒ…æ‹¬é‡å…¥å’Œè®¾ç½®ç¬¬ä¸€ä¸ªè¯»é”æŒæœ‰è€…
            return 1; // æˆåŠŸ
        }
    }
}
```

  * **è¯»é”æ˜¯å…±äº«çš„ï¼ˆSharedï¼‰**ï¼šå®ƒåªå…³å¿ƒé«˜ 16 ä½ã€‚`tryAcquireShared` å¾ªç¯å°è¯•è·å–è¯»é”ã€‚å®ƒä¼šæ£€æŸ¥å†™é”è®¡æ•°æ˜¯å¦ä¸º 0ã€‚åªè¦å†™é”æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼ˆå³ä½¿æœ‰è¯»é”ï¼‰ï¼Œå®ƒå°±å¯ä»¥é€šè¿‡ `CAS` å¢åŠ é«˜ 16 ä½çš„è¯»é”è®¡æ•°ã€‚è¿™å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–è¯»é”ï¼Œå®ç°äº†è¯»è¯»å¹¶å‘ã€‚

**å…³é”®è®¾è®¡ï¼š** å°†ä¸€ä¸ª `int` çŠ¶æ€å˜é‡æ‹†åˆ†æˆé«˜ä½ 16 ä½ï¼Œå·§å¦™åœ°ç”¨ä¸€ä½åŸå­å˜é‡å®ç°äº†ä¸¤ç§é”çš„çŠ¶æ€ç®¡ç†ï¼Œè¿™æ˜¯ `ReentrantReadWriteLock` çš„ç²¾é«“æ‰€åœ¨ã€‚

-----

âœ… ä¸‰ã€å¸¸ç”¨æ–¹å¼ + ä»£ç ç¤ºä¾‹

`ReentrantReadWriteLock` çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€ä¸ª `final` å®ä¾‹ï¼Œç„¶åé€šè¿‡å®ƒçš„ `readLock()` å’Œ `writeLock()` æ–¹æ³•åˆ†åˆ«è·å–è¯»å†™é”ã€‚

```java
import java.util.concurrent.locks.ReentrantReadWriteLock;

public class CacheData {
    private Object data;
    // åˆ›å»ºä¸€ä¸ªè¯»å†™é”å®ä¾‹
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    // è¯»é”
    private final ReentrantReadWriteLock.ReadLock readLock = rwl.readLock();
    // å†™é”
    private final ReentrantReadWriteLock.WriteLock writeLock = rwl.writeLock();

    /**
     * æ¨¡æ‹Ÿè¯»æ“ä½œï¼Œå…è®¸å¤šçº¿ç¨‹å¹¶å‘è¯»å–
     */
    public Object read() {
        readLock.lock(); // è·å–è¯»é”
        try {
            System.out.println(Thread.currentThread().getName() + " å¼€å§‹è¯»å–æ•°æ®...");
            // æ¨¡æ‹Ÿè¯»å–è€—æ—¶
            Thread.sleep(100); 
            System.out.println(Thread.currentThread().getName() + " è¯»å–æ•°æ®å®Œæˆã€‚");
            return data;
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return null;
        } finally {
            readLock.unlock(); // é‡Šæ”¾è¯»é”
        }
    }

    /**
     * æ¨¡æ‹Ÿå†™æ“ä½œï¼Œç‹¬å é”ï¼Œä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹å†™å…¥
     */
    public void write(Object newData) {
        writeLock.lock(); // è·å–å†™é”
        try {
            System.out.println(Thread.currentThread().getName() + " æ­£åœ¨å†™å…¥æ•°æ®...");
            // æ¨¡æ‹Ÿå†™å…¥è€—æ—¶
            Thread.sleep(1000); 
            this.data = newData;
            System.out.println(Thread.currentThread().getName() + " å†™å…¥æ•°æ®å®Œæˆã€‚");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            writeLock.unlock(); // é‡Šæ”¾å†™é”
        }
    }

    public static void main(String[] args) {
        CacheData cache = new CacheData();

        // æ¨¡æ‹Ÿå¤šä¸ªè¯»çº¿ç¨‹
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                cache.read();
            }, "Reader-" + i).start();
        }

        // æ¨¡æ‹Ÿä¸€ä¸ªå†™çº¿ç¨‹
        new Thread(() -> {
            cache.write("new data");
        }, "Writer-0").start();
    }
}
```

**ä»£ç æ³¨é‡Šï¼š**

  * **`readLock.lock()` å’Œ `readLock.unlock()`ï¼š** è¯»æ“ä½œï¼Œå…è®¸å¹¶å‘ï¼Œæ‰€ä»¥å¤šä¸ª `Reader` çº¿ç¨‹ä¼šå‡ ä¹åŒæ—¶å¼€å§‹å’Œç»“æŸã€‚
  * **`writeLock.lock()` å’Œ `writeLock.unlock()`ï¼š** å†™æ“ä½œï¼Œç‹¬å é”ï¼Œ`Writer-0` çº¿ç¨‹ä¼šç‹¬å èµ„æºï¼Œåœ¨å…¶æ‰§è¡ŒæœŸé—´ï¼Œæ‰€æœ‰è¯»çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å†™é”é‡Šæ”¾ã€‚
  * **`try-finally` å—ï¼š** è¿™æ˜¯ä¸€ä¸ªæœ€ä½³å®è·µï¼Œç¡®ä¿æ— è®ºä»£ç æ˜¯å¦æŠ›å‡ºå¼‚å¸¸ï¼Œé”éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚

-----

ğŸ¯ å››ã€çœŸå®é¢è¯•é«˜é¢‘é—®é¢˜ + æ·±åº¦è§£æ

**1. ä¸ºä»€ä¹ˆè¦ç”¨ `ReentrantReadWriteLock`ï¼Ÿå®ƒå’Œ `ReentrantLock` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

  * **æ ‡å‡†ç­”æ¡ˆï¼š** `ReentrantReadWriteLock` é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå®ƒå…è®¸å¤šä¸ªè¯»çº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œè€Œ `ReentrantLock` æ˜¯ä¸€ç§ç‹¬å é”ï¼Œä»»ä½•æ—¶å€™åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œå³ä½¿æ˜¯è¯»æ“ä½œä¹Ÿéœ€è¦æ’é˜Ÿã€‚
  * **è¯¦ç»†è§£æï¼š** `ReentrantLock` æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œåªè¦æœ‰çº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œå°±è®¤ä¸ºä¼šå‘ç”Ÿå†²çªï¼Œæ‰€ä»¥éƒ½åŠ é”ã€‚è€Œ `ReentrantReadWriteLock` æ˜¯ä¸€ç§æ›´æ™ºèƒ½çš„é”ï¼Œå®ƒæ ¹æ®æ“ä½œç±»å‹ï¼ˆè¯»æˆ–å†™ï¼‰æ¥å†³å®šæ˜¯å¦éœ€è¦ç‹¬å ï¼Œè¿™å¤§å¤§æå‡äº†è¯»å¤šå†™å°‘åœºæ™¯çš„æ€§èƒ½ã€‚
  * **é™·é˜±è­¦å‘Šï¼š** ä»…ä»…è¯´ä¸€ä¸ªæ”¯æŒè¯»å†™å¹¶å‘ï¼Œå¦ä¸€ä¸ªä¸æ”¯æŒæ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚ä½ éœ€è¦è¯´æ˜å…¶èƒŒåçš„**æ€æƒ³å·®å¼‚ï¼ˆä¹è§‚ vs æ‚²è§‚ï¼‰**ï¼Œä»¥åŠç”±æ­¤å¸¦æ¥çš„**æ€§èƒ½å’Œé€‚ç”¨åœºæ™¯çš„åŒºåˆ«**ã€‚

**2. `ReentrantReadWriteLock` çš„è¯»å†™é”æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ**

  * **æ ‡å‡†ç­”æ¡ˆï¼š** è¯»å†™é”æ˜¯åŸºäº AQS çš„ `state` çŠ¶æ€å˜é‡å®ç°çš„ã€‚`state` çš„é«˜ 16 ä½ç”¨äºè¡¨ç¤ºè¯»é”çš„è®¡æ•°ï¼Œä½ 16 ä½ç”¨äºè¡¨ç¤ºå†™é”çš„è®¡æ•°ã€‚
  * **è¯¦ç»†è§£æï¼š**
      * **å†™é”è·å–ï¼š** å†™é”æ˜¯ç‹¬å çš„ï¼Œå®ƒé€šè¿‡ `tryAcquire()` æ–¹æ³•å°è¯•å°† `state` ä» 0 é€šè¿‡ `CAS` å˜ä¸º 1ã€‚å¦‚æœ `state` ä¸ä¸º 0ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–å†™é”ï¼Œè·å–å¤±è´¥ã€‚
      * **è¯»é”è·å–ï¼š** è¯»é”æ˜¯å…±äº«çš„ï¼Œå®ƒé€šè¿‡ `tryAcquireShared()` æ–¹æ³•å°è¯•å¢åŠ  `state` çš„é«˜ 16 ä½ã€‚åªè¦å†™é”è®¡æ•°ä¸º 0ï¼Œè¯»é”å°±å¯ä»¥é€šè¿‡ `CAS` æˆåŠŸè·å–ã€‚
  * **é™·é˜±è­¦å‘Šï¼š** é¢è¯•å®˜ä¼šè¿½é—® `state` çš„é«˜ä½ä½æ˜¯å¦‚ä½•åˆ’åˆ†çš„ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ä½è¿ç®—è¿›è¡Œæ“ä½œï¼Œè¿™éœ€è¦ä½ å¯¹ AQS çš„æºç æœ‰ä¸€å®šäº†è§£ã€‚

**3. `ReentrantReadWriteLock` çš„å†™é”æ˜¯å¯é‡å…¥çš„å—ï¼Ÿè¯»é”å‘¢ï¼Ÿ**

  * **æ ‡å‡†ç­”æ¡ˆï¼š** éƒ½æ˜¯å¯é‡å…¥çš„ã€‚
  * **è¯¦ç»†è§£æï¼š**
      * **å†™é”é‡å…¥ï¼š** å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†å†™é”ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å†æ¬¡è·å–å†™é”ã€‚æºç ä¸­ `getExclusiveOwnerThread() == current` å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªçº¿ç¨‹åœ¨é‡å…¥ã€‚
      * **è¯»é”é‡å…¥ï¼š** å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯»é”ï¼Œå®ƒå¯ä»¥å†æ¬¡è·å–è¯»é”ã€‚è¯»é”çš„é‡å…¥è®¡æ•°å™¨åœ¨ `ThreadLocal` ä¸­ç»´æŠ¤ï¼Œè€Œä¸æ˜¯ AQS çš„ `state` ä¸­ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¹¶å‘è¯»é”è®¡æ•°å™¨å†²çªã€‚
  * **é™·é˜±è­¦å‘Šï¼š** å®¹æ˜“å¿½ç•¥è¯»é”çš„é‡å…¥æ€§ï¼Œæˆ–è€…ä¸çŸ¥é“è¯»é”çš„é‡å…¥è®¡æ•°æ˜¯å•ç‹¬ç»´æŠ¤çš„ã€‚

**4. ä¸ºä»€ä¹ˆè¯»é”ä¸èƒ½å‡çº§ä¸ºå†™é”ï¼Ÿ**

  * **æ ‡å‡†ç­”æ¡ˆï¼š** ä¸ºäº†é˜²æ­¢æ­»é”ã€‚
  * **è¯¦ç»†è§£æï¼š**
      * å‡è®¾çº¿ç¨‹ A æŒæœ‰è¯»é”ï¼Œæƒ³å‡çº§ä¸ºå†™é”ã€‚
      * çº¿ç¨‹ B ä¹ŸæŒæœ‰è¯»é”ï¼Œä¹Ÿæƒ³å‡çº§ä¸ºå†™é”ã€‚
      * çº¿ç¨‹ A éœ€è¦ç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾ï¼ˆåŒ…æ‹¬çº¿ç¨‹ B çš„è¯»é”ï¼‰ï¼Œæ‰èƒ½è·å–å†™é”ã€‚
      * çº¿ç¨‹ B éœ€è¦ç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾ï¼ˆåŒ…æ‹¬çº¿ç¨‹ A çš„è¯»é”ï¼‰ï¼Œæ‰èƒ½è·å–å†™é”ã€‚
      * ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾è¯»é”ï¼Œå½¢æˆå¾ªç¯ä¾èµ–ï¼Œå¯¼è‡´æ­»é”ã€‚
  * **é™·é˜±è­¦å‘Šï¼š** è¿™é“é¢˜è€ƒå¯Ÿä½ å¯¹é”å‡çº§å’Œæ­»é”çš„ç†è§£ï¼Œæ˜¯é¢è¯•ä¸­çš„é«˜é¢‘é¢˜ã€‚

-----

ğŸ’¡ äº”ã€å£è¯€ + è¡¨æ ¼/å›¾ç¤ºè¾…åŠ©è®°å¿†

**é”çš„ç‰¹æ€§å£è¯€**

> **è¯»è¯»å¯ä»¥ï¼Œå†™å†™äº’æ–¥ã€‚**
> **è¯»å†™äº’æ–¥ï¼Œè¯»å†™ä¸å‡çº§ã€‚**

**`ReentrantReadWriteLock` å·¥ä½œæµ**

**é”çš„å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | ReentrantLock | ReentrantReadWriteLock |
| :--- | :--- | :--- |
| **é”ç±»å‹** | ç‹¬å é” | è¯»å†™é” |
| **å¹¶å‘åº¦** | ä½ï¼Œä»»æ„æ“ä½œéƒ½éœ€æ’é˜Ÿ | é«˜ï¼Œå…è®¸å¤šä¸ªè¯»çº¿ç¨‹å¹¶è¡Œ |
| **é€‚ç”¨åœºæ™¯**| è¯»å†™å‡è¡¡æˆ–å†™å¤šè¯»å°‘ | è¯»å¤šå†™å°‘ |
| **å®ç°** | åŸºäº AQS ç‹¬å æ¨¡å¼ | åŸºäº AQS å…±äº«å’Œç‹¬å æ¨¡å¼ |
| **é‡å…¥æ€§** | å¯é‡å…¥ | è¯»å†™é”éƒ½å¯é‡å…¥ |

-----

ğŸ å…­ã€å»ºè®® + è¯¯åŒºæé†’

**è¯¯åŒºæé†’**

1.  **è¯»é”ä¸ç­‰äºçº¿ç¨‹å®‰å…¨ï¼š** è¯»é”åªä¿è¯å¹¶å‘è¯»çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸èƒ½ä¿è¯å†™æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚å¦‚æœä½ åœ¨è¯»é”ä¿æŠ¤çš„èŒƒå›´å¤–å¯¹å…±äº«å˜é‡è¿›è¡Œä¿®æ”¹ï¼Œä»ç„¶å¯èƒ½å‡ºç°é—®é¢˜ã€‚
2.  **å¿˜è®°é‡Šæ”¾é”ï¼š** è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œå¦‚æœæ²¡æœ‰åœ¨ `finally` å—ä¸­è°ƒç”¨ `unlock()`ï¼Œä¸€æ—¦å‘ç”Ÿå¼‚å¸¸ï¼Œé”å°†æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ°¸ä¹…é˜»å¡ã€‚

**ä½¿ç”¨å»ºè®®**

1.  **æ˜ç¡®ä½¿ç”¨åœºæ™¯ï¼š** åªæœ‰åœ¨ä½ çš„ç¨‹åºä¸­è¯»æ“ä½œè¿œè¿œå¤šäºå†™æ“ä½œæ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ `ReentrantReadWriteLock`ï¼Œå¦åˆ™ `ReentrantLock` æˆ– `synchronized` ç®€å•é”å°±è¶³å¤Ÿäº†ã€‚
2.  **é¿å…åœ¨é”å†…æ‰§è¡Œè€—æ—¶æ“ä½œï¼š** ä¸ç®¡æ˜¯è¯»é”è¿˜æ˜¯å†™é”ï¼Œéƒ½ä¸è¦åœ¨ `lock()` å’Œ `unlock()` ä¹‹é—´æ‰§è¡Œè€—æ—¶è¿‡é•¿çš„æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰ï¼Œè¿™ä¼šå¤§å¤§é™ä½é”çš„æ€§èƒ½ã€‚
3.  **æ³¨æ„é”é™çº§ï¼š** `ReentrantReadWriteLock` æ”¯æŒé”é™çº§ã€‚å³ï¼šå…ˆè·å–å†™é” -\> æ‰§è¡Œå†™æ“ä½œ -\> è·å–è¯»é” -\> é‡Šæ”¾å†™é” -\> æ‰§è¡Œè¯»æ“ä½œã€‚è¿™æ ·åšå¯ä»¥ä¿è¯å†™é”é‡Šæ”¾åï¼Œä»ç„¶æŒæœ‰è¯»é”ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¿®æ”¹æ•°æ®ã€‚
      * **æ³¨æ„ï¼š** é”å‡çº§ï¼ˆè¯»é” -\> å†™é”ï¼‰æ˜¯ä¸è¢«å…è®¸çš„ã€‚